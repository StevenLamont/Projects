(function(){var ca={lat:43.69587827770483,lng:-79.45175170898438},da={fillColor:"#000000",strokeColor:"#000000",strokeWeight:2},ea={fillColor:"#FF0000",strokeColor:"#FF0000",strokeWeight:4},v,C=[],r=null;angular.module("eventCalendarApp").controller("EventCalendarController",["$rootScope","$scope","$sanitize","$log","$state","$parse","$http","$timeout","$document","uiGmapGoogleMapApi","uiGmapIsReady","FileUploader","ngProgressFactory","ecCoTEventCacheService","ecCoTDataService","ecCoTUtilService",
"tmpSubmitAPIService","CoTSubmitAPIService","CoTGoogleMapUtilsService","CoTSession","CoTUserRoles","CoTNotifyService",function(ra,f,sa,g,w,ta,ua,h,fa,ga,ha,Q,ia,x,n,p,u,R,y,ja,D,ka){function la(a){var c;c=0<=a.split(",")[0].indexOf("base64")?atob(a.split(",")[1]):unescape(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var d=new Uint8Array(c.length),e=0;e<c.length;e++)d[e]=c.charCodeAt(e);return new Blob([d],{type:a})}function ma(){var b=angular.element(document.querySelector("canvas"))[0].toDataURL(),
c=la(b),b=new FormData,d=a.event.image.fileName.split(".");d.pop();var e="th_"+d.join(".")+".png";b.append("file",c,e);R.uploadAttachment("dev_eventcal","event_logo",b).then(function(b){b.hasOwnProperty("BIN_ID")?(a.event.thumbImage||(a.event.thumbImage={}),a.event.thumbImage.fileName=e,a.event.thumbImage.fileSize=c.size,a.event.thumbImage.fileType=c.type,a.event.thumbImage.binId=b.BIN_ID[0]):sweetAlert("File Upload Failure","The file upload was successful but the generated thumbnail failed. Please remove the image and try again!",
"error")},function(a){sweetAlert("File Upload Failure","The file upload was successful but the generated thumbnail failed. Please remove the image and try again!","error")})}function na(){var b=("update"==a.appCntl.opMode?z()+"/cc_sr_admin_v1":z()+"/cc_sr_v1")+"/upload/dev_eventcal/event_logo";a.uploader=new Q({url:b});a.uploader.filters.push({name:"imageFilter",fn:function(a,b){var e="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|gif|".indexOf(e)}},{name:"sizeFilter",fn:function(a,
b){return 2>a.size/1024/1024}});a.uploader.onWhenAddingFileFailed=function(a,b,e){sweetAlert("Invalid file type.","Only image files less than 2 MB are allowed to be uploaded. \n (jpg, jpeg, png, gif)","error")};a.uploader.onAfterAddingFile=function(b){g.debug("onAfterAddingFile",b);a.event.image||(a.event.image={});a.event.image.fileName=b.file.name;a.event.image.fileSize=b.file.size;a.event.image.fileType=b.file.type;a.newImageInUse=!0};a.uploader.onSuccessItem=function(b,d,e,m){g.debug("onSuccessItem",
b,d,e,m);h(function(){a.event.image||(a.event.image={});d.hasOwnProperty("BIN_ID")?a.event.image.binId=d.BIN_ID[0]:sweetAlert("File Upload Failed","The file upload was not successful. Please Try again!","error")});ma()};a.uploader.onErrorItem=function(a,b,e,m){sweetAlert("File Upload Failed","The file upload was not successful. Please Try again!","error")};f.$watch(angular.bind(a,function(){return a.uploader.queue.length}),function(b){0===a.uploader.queue.length&&(a.newImageInUse=!1,a.event.image&&
(delete a.event.image.binId,delete a.event.image.fileName,delete a.event.image.fileSize,delete a.event.image.fileType))})}function S(){f.ecForm.$setPristine();f.ecForm.$setUntouched();f.$broadcast("show-errors-reset")}function oa(){var b=[],c=new Q.FileItem(a.uploader,{dateModified:"today",size:a.event.image.fileSize,type:a.event.image.fileType,name:a.event.image.fileName});c.progress=100;c.isUploaded=!0;c.isSuccess=!0;b.push(c);a.uploader.queue.push(c);a.uploader.onAfterAddingFile(c);a.uploader.onAfterAddingAll(b);
a.uploader._render();a.newImageInUse=!1}function E(){n.eventCategories().then(function(b){a.eventCategories=p.resetInputModel("name",a.event.category,b);a.limitSelection("",a.eventCategories,a.event.category,3)});n.eventThemes().then(function(b){a.eventThemes=p.resetInputModel("name",a.event.theme,b)});n.costRanges().then(function(b){a.costRanges=p.resetInputModel("value",a.event.costRange,b)});a.event.admin&&n.newsletterCategories().then(function(b){a.newsletterCategories=p.resetInputModel("value",
a.event.admin.newsletterCategory,b);if(a.event.admin.newsletterCategory&&0<a.event.admin.newsletterCategory.length){b=a.event.admin.newsletterCategory[0].value;if("Attractions/Happenings"===b||"Sports"===b)a.newsletterSubCatRequired=!0;b&&(g.debug("load newsltter SubCat: "+b),n.newsletterSubcategories(b).then(function(b){a.newsletterSubcategories=p.resetInputModel("value",a.event.admin.newsletterSubcategory,b)}))}else n.newsletterSubcategories("").then(function(b){a.newsletterSubcategories=b})});
n.sportsSubcategories().then(function(b){a.sportsSubcategories=p.resetInputModel("name",a.event.sportsSubcategory,b)});a.weeklyDatesIM=[];angular.forEach(a.event.weeklyDates,function(b,c){a.weeklyDatesIM.push({dayOfWeekValues:p.resetInputModel("day",b.weekDay,n.daysOfWeek())})});a.uploader.clearQueue();a.event.image&&a.event.image.binId&&"update"===a.appCntl.opMode&&oa();a.event.image&&a.event.image.binId&&(a.imageURL=("update"==a.appCntl.opMode?z()+"/cc_sr_admin_v1":z()+"/cc_sr_v1")+"/upload/dev_eventcal/"+
a.event.image.binId+"?sid="+a.appCntl.sid)}function T(){fa.find("#ecForm")[0].reset();a.event.category=[];a.event.costRange=[];a.weeklyDatesIM=[];angular.copy(a.eventDefaults,a.event);E();F();pa();S();t(1);q()}function G(){if(a.appCntl.showMap&&4===a.appCntl.tab){g.debug("do reset map");if(0<a.mapMarkers.length){for(var b=new google.maps.LatLngBounds,c=0;c<a.mapMarkers.length;c++)a.mapMarkers[c].type===google.maps.drawing.OverlayType.MARKER?b.extend(a.mapMarkers[c].position):a.mapMarkers[c].type===
google.maps.drawing.OverlayType.POLYGON?a.mapMarkers[c].getPaths().forEach(function(a,c){a.getArray().forEach(function(a,c){b.extend(a)})}):a.mapMarkers[c].type===google.maps.drawing.OverlayType.POLYLINE&&a.mapMarkers[c].getPath().forEach(function(a,c){b.extend(a)});a.map.mapControl.getGMap().fitBounds(b);c=a.map.mapControl.getGMap().getZoom();g.debug(c);16<c&&(c=16);a.map.mapControl.getGMap().setZoom(c);g.debug(c)}else g.debug("no markers - center on toronto"),a.map.mapControl.getGMap().setZoom(10),
a.map.mapControl.getGMap().setCenter(ca);r.close()}}function H(){"undefined"===typeof a.event.dates&&(a.event.dates=[]);a.event.dates.push({});q()}function I(){"undefined"===typeof a.event.weeklyDates&&(a.event.weeklyDates=[],a.weeklyDatesIM=[]);var b=[];angular.copy(a.daysOfWeek,b);a.event.weeklyDates.push({weekDay:[],startTime:moment().add(1,"hour").startOf("hour"),endTime:moment().add(2,"hour").startOf("hour")});a.weeklyDatesIM.push({dayOfWeekValues:b})}function A(b){"undefined"===typeof a.event.locations&&
(a.event.locations=[]);"undefined"===typeof b?a.event.locations.push({id:p.guid(),type:"marker"}):a.event.locations.push(b);q()}function U(b){var c=a.event.locations[b].id;a.event.locations.splice(b,1);var d=-1;angular.forEach(a.mapMarkers,function(a,b){a.locId===c&&(a.setMap(null),a.locId=-1,d=b)});-1<d&&a.mapMarkers.splice(d,1)}function V(b,c,d){for(var e=!1,m=0;m<a.mapMarkers.length;m++)a.mapMarkers[m].locId===b&&(a.mapMarkers[m].setPosition(c),e=!0);e||(b=new google.maps.Marker({position:c,locId:b,
draggable:!0,map:a.map.mapControl.getGMap(),icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png",type:"marker"}),W(b),a.mapMarkers.push(b));d&&G()}function X(b){var c=a.event.locations[b].address;if(!_.isEmpty(c)){var d=a.event.locations[b].id;qa(c,function(c,m){h(function(){a.event.locations[b].coords=c;a.event.locations[b].address=m;a.event.locations[b].geoCoded=!0});V(d,c,!0);y.isLatLngInToronto(c)||sweetAlert("Warning","Location is outside the city boundaries","warning")});a.resetMap()}}
function Y(){angular.forEach(a.event.locations,function(a,c){a.geoCoded||_.isEmpty(a.address)||a.type!==google.maps.drawing.OverlayType.MARKER||(g.debug("found non-geocoded address"),a.address="")})}function J(){"None"===a.event.partnerType&&delete a.event.partnerName;"once"==a.event.frequency?(delete a.event.startDate,delete a.event.endDate,delete a.event.dates,delete a.event.weeklyDates):"dates"==a.event.frequency?(delete a.event.weeklyDates,delete a.event.startDateTime,delete a.event.endDateTime,
"undefined"!=typeof a.event.dates&&0!==a.event.dates.length||H()):"weekly"==a.event.frequency&&(delete a.event.dates,delete a.event.startDateTime,delete a.event.endDateTime,"undefined"!=typeof a.event.weeklyDates&&0!==a.event.weeklyDates.length||I());a.isSportsSelected||delete a.event.sportsSubcategory;"Other"!==a.event.orgType&&delete a.event.orgTypeOther;0===a.event.locations.length&&A();a.event.admin.newsletterCategory&&0<a.event.admin.newsletterCategory.length&&("Attractions/Happenings"!==a.event.admin.newsletterCategory[0].value&&
"Sports"!==a.event.admin.newsletterCategory[0].value&&(a.event.admin.newsletterSubcategory=[]),0<a.uploader.queue.length?!a.event.image||_.isEmpty(a.event.image.binId)?(sweetAlert("Image Problem","The event image was not properly uploaded. Either upload the image or remove it."),f.ecForm.$setValidity("badImage",!1)):f.ecForm.$setValidity("badImage",!0):a.event.image&&_.isEmpty(a.event.image.binId)&&delete a.event.image)}function K(){"once"==a.event.frequency&&(a.event.startDate=moment(a.event.startDateTime).startOf("day"),
a.event.endDate=moment(a.event.endDateTime).startOf("day"),a.event.dates||(a.event.dates=[]),a.event.dates.push({startDateTime:a.event.startDateTime,endDateTime:a.event.endDateTime}));"weekly"==a.event.frequency&&(a.event.dates||(a.event.dates=[]),angular.forEach(a.event.weeklyDates,function(b,c){var d=moment(a.event.startDate),e=moment(b.startTime),m=moment(b.endTime),f=moment(a.event.endDate).diff(d,"days")+1;for(i=0;i<f;i++){console.log(d.format("dddd"),b.weekDay[0].day);if(d.format("dddd")===
b.weekDay[0].day){console.log(d.day());var l=moment(d),l=l.add(e.hour(),"hours"),l=l.add(e.minute(),"minutes"),k=moment(d),k=k.add(m.hour(),"hours"),k=k.add(m.minute(),"minutes");console.log(l.format("YYYY-MM-DD HH:mm"),k.format("YYYY-MM-DD HH:mm"));a.event.dates.push({startDateTime:l,endDateTime:k})}d=d.add(1,"days")}}));a.event.categoryString="";angular.forEach(a.event.category,function(b,c){a.event.categoryString+=(0<a.event.categoryString.length?",":"")+b.name});a.event.themeString="";angular.forEach(a.event.theme,
function(b,c){a.event.themeString+=(0<a.event.themeString.length?",":"")+b.name})}function L(){var b=angular.element(document.querySelector("#ecForm")),c=angular.element(b.find(".ng-invalid")[0]);if(c){a.debug&&("undefined"===typeof c.attr("id")?sweetAlert("Validation Error",c.attr("name")):sweetAlert("Validation Error",c.attr("id")));var d=c.closest(".panel-body").attr("id").replace("ec-step","");b.find(".tab-pane").removeClass("active").removeClass("in");angular.element("#buttonbar").find("li").removeClass("active");
c.closest(".tab-pane").addClass("active").addClass("in");c[0].focus();a.appCntl.tab=parseInt(d,10)}}function Z(){angular.forEach(a.mapMarkers,function(a,c){a.setMap(null)});a.mapMarkers=[];angular.forEach(a.event.locations,function(b,c){if(b.type===google.maps.drawing.OverlayType.MARKER){if("undefined"!==typeof b.coords){var d=new google.maps.LatLng(b.coords.lat,b.coords.lng);V(b.id,d,!1)}}else"polygon"===b.type?(d=new google.maps.Polygon({paths:b.coords,strokeWeight:0,fillOpacity:.45,editable:!0,
draggable:!0,type:"polygon",locId:b.id}),d.setMap(a.map.mapControl.getGMap()),aa(d)):(d=new google.maps.Polyline({path:b.coords,Geodesic:!0,strokeWeight:2,fillOpacity:.45,strokeOpacity:.8,editable:!0,draggable:!0,type:"polyline",locId:b.id}),d.setMap(a.map.mapControl.getGMap()),ba(d)),a.mapMarkers.push(d)});G()}function F(){C.forEach(function(a){a.setMap(null)});C=[]}function pa(){a.mapMarkers.forEach(function(a){a.setMap(null)});a.mapMarkers=[]}function M(){var b;if(a.selectedShape){b="undefined"===
typeof a.selectedShape.type?google.maps.drawing.OverlayType.MARKER:a.selectedShape.type;b!==google.maps.drawing.OverlayType.MARKER&&a.selectedShape.setEditable(!1);h(function(){a.selectedShape=null});for(var c=0;c<a.mapMarkers.length;c++)b="undefined"===typeof a.mapMarkers[c].type?google.maps.drawing.OverlayType.MARKER:a.mapMarkers[c].type,b===google.maps.drawing.OverlayType.MARKER?a.mapMarkers[c].setIcon("http://maps.google.com/mapfiles/ms/icons/blue-dot.png"):a.mapMarkers[c].setOptions(da)}}function B(b){M();
F();var c="undefined"===typeof b.type?google.maps.drawing.OverlayType.MARKER:b.type;if(c!==google.maps.drawing.OverlayType.MARKER)b.setEditable(!0),b.setOptions(ea);else{for(var d=0;d<a.mapMarkers.length;d++)c="undefined"===typeof a.mapMarkers[d].type?google.maps.drawing.OverlayType.MARKER:a.mapMarkers[d].type,c===google.maps.drawing.OverlayType.MARKER&&a.mapMarkers[d].setIcon("http://maps.google.com/mapfiles/ms/icons/blue-dot.png");b.setIcon("http://maps.google.com/mapfiles/ms/icons/red.png")}h(function(){a.selectedShape=
b})}function qa(b,c){v.geocode({address:b,bounds:a.map.mapControl.getGMap().getBounds()},function(a,b){b===google.maps.GeocoderStatus.OK?a[0]?c(a[0].geometry.location,a[0].formatted_address):sweetAlert("No results found"):sweetAlert("Address verification failed","Please try another address ("+b+")","warning")})}function N(b){var c=this.locId,d=this.type,e="";angular.forEach(a.event.locations,function(a,b){a.id===c&&(e="<b>Location "+(b+1)+"</b>",e+="undefined"!=typeof a.locationName?": "+a.locationName:
"",e+="undefined"!=typeof a.address?"<br>"+a.address:"")});var m=new google.maps.Size(0,-6);d===google.maps.drawing.OverlayType.MARKER&&(m=new google.maps.Size(0,-30));r.setOptions({position:b.latLng,pixelOffset:m,content:e});r.close();r.open(a.map.mapControl.getGMap())}function W(b){google.maps.event.addListener(b,"mouseover",N);google.maps.event.addListener(b,"click",function(a){B(b)});google.maps.event.addListener(b,"dragend",function(b){r.close();for(var d=this.locId,e=0;e<a.event.locations.length;e++)if(a.event.locations[e].id===
d){var m=e;v.geocode({location:b.latLng},function(d,e){e===google.maps.GeocoderStatus.OK&&h(function(){a.event.locations[m].address=d[0].formatted_address;a.event.locations[m].coords=b.latLng;a.event.locations[m].geoCoded=!0})});y.isLatLngInToronto(b.latLng)||sweetAlert("Warning","Location is outside the city boundaries","warning")}})}function O(b,c){var d=this.locId,e=this.getArray();h(function(){angular.forEach(a.event.locations,function(a,b){a.id===d&&(a.coords=e)})})}function ba(a){google.maps.event.addListener(a,
"click",function(c){B(a)});a.getPath().locId=a.locId;google.maps.event.addListener(a.getPath(),"insert_at",O);google.maps.event.addListener(a.getPath(),"remove_at",O);google.maps.event.addListener(a.getPath(),"set_at",O);google.maps.event.addListener(a,"mouseover",N)}function P(b,c){var d=this.locId,e=this.getArray();h(function(){angular.forEach(a.event.locations,function(a,b){a.id===d&&(a.coords=e)})})}function aa(a){google.maps.event.addListener(a,"click",function(c){B(a)});google.maps.event.addListener(a,
"mouseover",N);a.getPaths().forEach(function(c,d){c.locId=a.locId;google.maps.event.addListener(c,"insert_at",P);google.maps.event.addListener(c,"remove_at",P);google.maps.event.addListener(c,"set_at",P)})}function q(){x.putEvent(a.event,a.appCntl)}function t(b){a.appCntl.tab=b;4===a.appCntl.tab&&a.appCntl.showMap&&(a.refreshMap(),h(function(){a.locationTabClicked=!a.locationTabClicked;f.$apply()}))}function z(){var b="https://was8-intra-dev.toronto.ca";return b="update"===a.appCntl.opMode?"https://was8-intra-dev.toronto.ca".replace("inter",
"intra"):"https://was8-intra-dev.toronto.ca".replace("intra","inter")}var a=this;a.roles=ja.userRoles;a.admin=D.getUserRoles().admin;a.approver=D.getUserRoles().approver;a.editor=D.getUserRoles().editor;a.MAX_TABS=7;g.debug(w.current.data);a.opMode=w.current.data.opMode;a.acceptableChars=/^[a-zA-Z0-9 \.]*$/;a.canDebug=!0;a.debug=!1;a.appRepo="dev_eventcal";a.eventDefaults={terms:"",recId:null,category:[],locations:[{id:p.guid(),type:"marker"}],admin:{newsletterCategory:[],newsletterSubcategory:[],
includeInNewsletter:!1,featuredEvent:!1}};a.event={terms:"",recId:null};a.weeklyDatesIM=[];a.appCntl={tab:1,showMap:!1};a.locationTabClicked=!1;a.progressbar=ia.createInstance();a.newImageInUse=!1;a.imageURL="";a.locIndex=-1;a.occurIndex=-1;a.recIdInput="";a.isSportsSelected=!0;a.newsletterSubCatRequired=!1;n.eventFeatures().then(function(b){a.availableFeatures=b});n.helpText().then(function(b){a.helpText=b});a.daysOfWeek=n.daysOfWeek();a.selectedShape=null;a.mapMarkers=[];a.map={center:{latitude:43.69587827770483,
longitude:-79.45175170898438},zoom:10};a.map.options={MapTypeId:"satellite"};a.map.mapControl={};a.searchbox={template:"searchbox.tpl.html",events:{places_changed:function(b){g.debug("places");F();b=b.getPlaces();if(0!==b.length){var c=a.map.mapControl.getGMap().getBounds();b.forEach(function(b){b.geometry.viewport?c.union(b.geometry.viewport):c.extend(b.geometry.location);C.push(new google.maps.Marker({map:a.map.mapControl.getGMap(),icon:"images/centre.png",title:b.name,position:b.geometry.location}))});
a.map.mapControl.getGMap().fitBounds(c)}}}};a.limitSelection=p.limitSelection;a.clearSelection=p.clearSelection;a.blur=function(a){g.debug("blur:"+a);angular.element(a).blur()};a.setTab=t;a.resetForm=T;a.addOccurrenceDateRow=H;a.removeOccurrenceDateRow=function(b){a.event.dates.splice(b,1)};a.addWeeklyOccurrenceRow=I;a.removeWeeklyOccurrenceRow=function(b){a.event.weeklyDates.splice(b,1)};a.frequencyChanged=function(){"dates"!=a.event.frequency||"undefined"!=typeof a.event.dates&&0!==a.event.dates.length||
H();"weekly"!=a.event.frequency||"undefined"!=typeof a.event.weeklyDates&&0!==a.event.weeklyDates.length||I()};a.gotoHomePage=function(){x.removeEvent();window.location.href="http://toronto.ca"};a.beforeRenderEndDateTime=function(a,c,d,e,m,f,l,k,g){d=moment("20990101","YYYYMMDD");e=moment("19700101","YYYYMMDD");l&&(e="hour"===a||"minute"===a?moment(l):moment(l).startOf("day"));k&&(l=moment(k).startOf("day"),l.valueOf()>=e.valueOf()&&(e=l));g&&(d=moment(g).endOf("day"));for(g=0;g<c.length;g++)"hour"!==
a&&"minute"!==a&&"23:00"===moment(c[g].localDateValue()).format("HH:mm")&&(c[g].utcDateValue=moment(c[g].utcDateValue).add(1,"hour")),moment(c[g].localDateValue()).startOf(a)<=d.startOf(a)&&moment(c[g].localDateValue()).startOf(a)>=e.startOf(a)?c[g].selectable=!0:c[g].selectable=!1};a.beforeRenderStartDateTime=function(a,c,d,e,m,f,l,k,h){g.debug(f+" "+a+" Parent Start:"+("undefined"===typeof k?"blank":moment(k).format("YYYYMMDD HH:mm"))+" Parent end:"+("undefined"===typeof h?"blank":moment(h).format("YYYYMMDD HH:mm "))+
" end date:"+("undefined"===typeof l?"blank":moment(l).format("YYYYMMDD HH:mm")));d=moment("20990101","YYYYMMDD");e=moment("19700101","YYYYMMDD");l&&(d="hour"===a||"minute"===a?moment(l):moment(l).endOf("day"));h&&(l=moment(h).endOf("day"),l.valueOf()<d.valueOf()&&(d=l));k&&(e=moment(k).startOf("day"));for(k=0;k<c.length;k++)"hour"!==a&&"minute"!==a&&"23:00"===moment(c[k].localDateValue()).format("HH:mm")&&(c[k].utcDateValue=moment(c[k].utcDateValue).add(1,"hour")),moment(c[k].localDateValue()).startOf(a)<=
d.startOf(a)&&moment(c[k].localDateValue()).startOf(a)>=e.startOf(a)?(c[k].selectable=!0,g.debug("start:"+moment(c[k].localDateValue()).format("YYYYMMDD HH:mm")+" - allowed between( "+moment(e.valueOf()).format("YYYYMMDD HH:mm")+" & "+moment(d.valueOf()).format("YYYYMMDD HH:mm")+")")):(c[k].selectable=!1,g.debug("start:"+moment(c[k].localDateValue()).format("YYYYMMDD HH:mm")+" - not allowed "+moment(e.valueOf()).format("YYYYMMDD HH:mm")+" & "+moment(d.valueOf()).format("YYYYMMDD HH:mm")+")"))};a.addLocation=
A;a.removeLocation=U;a.verifyLocationAddress=X;a.locationAddressChanged=function(b){a.event.locations[b].geoCoded=!1;X(b)};a.displayAddressIndChanged=function(b){a.event.locations[b].displayAddressInd||delete a.event.locations[b].displayAddress};a.deleteSelectedShape=function(){if(a.selectedShape){r.close();a.selectedShape.setMap(null);var b=null,c=a.selectedShape.locId;1===a.event.locations.length?h(function(){a.event.locations=[]}):h(function(){angular.forEach(a.event.locations,function(a,e){a.id===
c&&(b=e)});-1<b&&U(b);a.selectedShape=null})}};a.PSIEntered=function(){return _.isEmpty(a.event.eventEmail)&&_.isEmpty(a.event.eventPhone)&&_.isEmpty(a.event.eventWebsite)?!0:!1};a.submit=function(){f.ecForm.$setSubmitted();J();Y();f.$broadcast("show-errors-check-validity");if(f.ecForm.$invalid)q(),L();else{K();a.progressbar.start();var b={calEvent:a.event},c=null;a.event.image&&a.event.image.binId&&(c="/calEvent/image/binId");R.submit("dev_eventcal",b,c).then(function(b){"undefined"!==typeof b?(sweetAlert("Submitted",
"The event was successfully submitted!","success"),a.progressbar.complete(),h(function(){a.event.recId=b.id;x.removeEvent();window.location.href=window.location.protocol+"//"+window.location.host+window.location.pathname},2E3)):(a.progressbar.complete(),sweetAlert("Submission Failed","The event was not submitted successfully. Please Try again!","error"))},function(){a.progressbar.complete();sweetAlert("Submission Failed","The event was not submitted successfully. Please Try again!","error")})}};a.preview=
function(){sweetAlert("Warning","Preview Not Impelmented yet.","warning")};a.nextTab=function(){var b=a.appCntl.tab+1;b<=a.MAX_TABS&&(t(b),q())};a.prevTab=function(){var b=a.appCntl.tab-1;0<b&&(t(b),q())};a.showTab=function(a){t(a);q()};a.updateRecord=function(){delete a.event.eventCategories;delete a.event.costRanges;delete a.event.tab;delete a.event.showMap;J();Y();f.$broadcast("show-errors-check-validity");if(f.ecForm.$invalid)q(),L();else{K();var b={calEvent:a.event};S();u.update("testweb1","toronto",
"dev_eventcal",a.event.recId,b).then(function(){window.location.reload(!0)})}};a.approveRecord=function(){u.approve("testwebadm","toronto","dev_eventcal",a.event.recId)};a.getAllRecords=function(){var a="";angular.element("#dataTable").html("");a="<h2>Events</h2>";a+="<table class='table table-striped table-bordered' style='display: block; overflow-x: auto;'><tr><th >Status</th><th >Id</th><th>Event Name</th><th >Event Description</th><th class='col-md-3'>Item</th><th >Created</th><th class='col-md-2'>Update</th></tr>";
u.getRepoData("evntappr","toronto","dev_eventcal","dev_eventcal",0,1E3).then(function(c){c=c.data.sort(function(a,b){return(new Date(b.updated)).getTime()-(new Date(a.updated)).getTime()});for(var d=0;d<c.length;d++){var e=c[d];if("undefined"!==typeof e){var f=JSON.parse(e.payload);f.calEvent?a+="<tr><td>"+("Yes"==e.status?"Submitted":e.status)+"</td><td>"+e.id+"</td><td>"+f.calEvent.eventName+"</td><td>"+f.calEvent.description+"</td><td class='col-md-3'>"+JSON.stringify(e)+"</td><td>"+e.created+
"</td><td>"+e.updated+"</td></tr>":console.log(e.id,e.payload)}}a+="</table>";$("#dataTable").html(a)}).then(function(a,b){console.log(a)})};a.getOneRecord=function(){T();u.login("dev_eventcal","evntappr","toronto").then(function(b){a.appCntl.sid=b.sid});u.retrieve("evntappr","toronto","dev_eventcal",a.recIdInput).then(function(b){h(function(){var c=JSON.parse(b.data.payload);a.event=c.calEvent;a.event.recId=b.data.id;Z();E();t(1);q()})}).then(function(a,c,d,e){console.log(a)})};a.returnRecord=function(b){console.log("validating, then returning to "+
document.referrer);J();f.$broadcast("show-errors-check-validity");f.ecForm.$invalid?(q(),L()):(K(),q(),console.log("EventCalendarController broadcasting event-updated."),a.appCntl.status=b,ka.notify(b))};a.cancelEdit=function(){a.appCntl.callerState&&w.go(a.appCntl.callerState)};a.toggleMap=function(){a.appCntl.showMap=!a.appCntl.showMap;a.refreshMap()};a.refreshMap=function(){};a.resetMap=G;a.drawingManagerOptions={};a.drawingManagerControl={};a.eventDateChanged=function(a,c){f.$broadcast("eventdatechange")};
a.eventDateBlur=function(a,c,d,e){console.log("blur:",a,c,d,e);"undefined"!==typeof c&&"undefined"!==typeof e&&moment(c)>moment(e)?(f.ecForm[a].$setValidity("baddate",!1),f.ecForm[d].$setValidity("baddate",!1)):(f.ecForm[a].$setValidity("baddate",!0),f.ecForm[d].$setValidity("baddate",!0));f.$broadcast("eventdatechange")};a.eventOccurDateBlur=function(a,c,d,e,g,h){"undefined"!==typeof c&&"undefined"!==typeof e&&moment(c)>moment(e).endOf("day")?(f.ecForm[a].$setValidity("baddate",!1),f.ecForm[d].$setValidity("baddate",
!1)):(f.ecForm[a].$setValidity("baddate",!0),f.ecForm[d].$setValidity("baddate",!0));"undefined"!==typeof c&&(moment(c)<moment(g).startOf("day")||moment(c)>moment(h).endOf("day"))?f.ecForm[a].$setValidity("badoccurdate",!1):f.ecForm[a].$setValidity("badoccurdate",!0);"undefined"!==typeof e&&(moment(e)>moment(h).endOf("day")||moment(e)<moment(g).startOf("day"))?f.ecForm[d].$setValidity("badoccurdate",!1):f.ecForm[d].$setValidity("badoccurdate",!0);f.$broadcast("eventdatechange")};angular.element(document).ready(function(){g.debug("angular ready");
var b=x.getEvent();null===b.event?(g.debug("loading event defaults"),angular.copy(a.eventDefaults,a.event)):(g.debug("loading event found in local storage"),angular.copy(b.event,a.event),b.appCntl&&angular.copy(b.appCntl,a.appCntl),a.appCntl.opMode=w.current.data.opMode,a.appCntl.opMode&&"update"==a.appCntl.opMode&&(a.MAX_TABS=8),a.appCntl.referrer=document.referrer);na();E();f.$watch(angular.bind(a,function(){return a.locationTabClicked}),function(b){g.debug("locationTabClicked: "+a.locationTabClicked);
a.refreshMap();h(function(){a.refreshMap()})});f.$watchCollection(angular.bind(a,function(){return a.event.category}),function(b,d){a.isSportsSelected=!1;angular.forEach(b,function(b,c){"Sports"===b.name&&(a.isSportsSelected=!0)})});h(function(){f.$watchCollection(angular.bind(a,function(){return a.event.admin.newsletterCategory}),function(b,d){0<b&&0<d&&b[0].value===d[0].value?g.debug("subcat watch - no Category change, skip:"+b[0].value):(a.newsletterSubCatRequired=!1,angular.forEach(b,function(b,
c){g.debug("reload subcat"+b.value);if("Attractions/Happenings"===b.value||"Sports"===b.value)a.newsletterSubCatRequired=!0,h(function(){n.newsletterSubcategories(b.value).then(function(b){a.newsletterSubcategories=b})})}))})},200)});ga.then(function(b){h(function(){var c={strokeWeight:0,fillOpacity:.45,editable:!0,draggable:!0};a.map.options={MapTypeId:b.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};a.mapControl=
{position:google.maps.ControlPosition.TOP_RIGHT};a.drawingManagerOptions={drawingMode:null,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.POLYGON,google.maps.drawing.OverlayType.POLYLINE]},markerOptions:{icon:"http://maps.google.com/mapfiles/ms/icons/red.png",draggable:!0},polylineOptions:{editable:!0,draggable:!0},rectangleOptions:c,polygonOptions:c}});a.drawingManagerEvents=
{overlaycomplete:function(b,d,e,f){d=f[0];e=d.overlay;f=p.guid();e.label=1;e.locId=f;a.mapMarkers.push(e);e.type=d.type;b.setDrawingMode(null);e.type===google.maps.drawing.OverlayType.POLYGON?aa(e):e.type===google.maps.drawing.OverlayType.POLYLINE?ba(e):W(e);B(e);if(e.type===google.maps.drawing.OverlayType.MARKER)n={id:f,type:e.type,coords:d.overlay.position},v.geocode({location:e.position},function(a,b){b===google.maps.GeocoderStatus.OK&&(n.address=a[0].formatted_address,n.geoCoded=!0);h(function(){A(n)})}),
y.isLatLngInToronto(e.position)||sweetAlert("Warning","Location is outside the city boundaries","warning");else{g.debug(e.getPath().getArray());b=e.getPath();var n={id:f,type:d.type,coords:[],address:e.type};for(d=0;d<b.length;d++)n.coords.push({lat:b.getAt(d).lat(),lng:b.getAt(d).lng()});A(n)}}};v=new google.maps.Geocoder;r=new google.maps.InfoWindow});ha.promise().then(function(b){_.isEmpty(a.map.mapControl)||(google.maps.event.addListener(a.map.mapControl.getGMap(),"bounds_changed",function(){(new google.maps.places.SearchBox(angular.element("#mapSearchBox")[0])).setBounds(a.map.mapControl.getGMap().getBounds())}),
google.maps.event.addListener(a.map.mapControl.getGMap(),"click",M),a.refreshMap=function(){a.appCntl.showMap&&4===a.appCntl.tab&&(g.debug("refreshMap()"),h(function(){google.maps.event.trigger(a.map.mapControl.getGMap(),"resize");a.map.mapControl.refresh();a.resetMap()}))},Z(),(new google.maps.Polyline({path:y.cityPolylineCoords(),Geodesic:!0,strokeWeight:1,strokeColor:"#FF0000",fillOpacity:.45,editable:!1,draggable:!1})).setMap(a.map.mapControl.getGMap()),g.debug("controller ready"));_.isEmpty(a.drawingManagerControl)||
(b=a.drawingManagerControl.getDrawingManager(),google.maps.event.addListener(b,"drawingmode_changed",M))})}])})();
