(function(h,C){function p(){for(var a={},c=h.location.search.substr(1).split("&"),d=0;d<c.length;d++)if(""!==c[d]){var b=c[d].split("=");2==b.length&&(a[b[0]]=decodeURIComponent(b[1].replace(/\+/g," ")))}return a}function x(a){var c="";Object.keys(a).forEach(function(d,b,g){c+=""===c?"?":"&";c+=d+"="+a[d]});return c}function q(a){var c=p();$.each(Object.keys(a),function(b,d){null!==a[d]?c[d]=String(a[d]).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,
"&gt;"):delete c[d]});var d=x(c),d=h.location.protocol+"//"+h.location.host+h.location.pathname+d;history.pushState&&history.pushState({},"ignored title",d)}function r(a){"undefined"!==typeof Storage&&(null!==a?localStorage.setItem("SWM_CC",JSON.stringify(a)):localStorage.removeItem("SWM_CC"))}function t(){var a=k.replace(/\s/g,""),c=moment().startOf("day"),d=0,b="";$.each(l,function(h,f){if(f.Calendar===a&&moment(f.WeekStarting)>=c&&2>d){var e="";d++;b+="<p class='listinghdr'>"+moment(f.WeekStarting).format("MMMM Do - dddd")+
"</p>";b+="<p>";"0"!==f.GreenBin&&(b+="<img src='"+g.greenbin+"' alt='Organic' title='Organic'>",e+="<span class='iconlbl'>Organic</span>");"0"!==f.Garbage&&(b+="<img src='"+g.garbage+"' alt='Garbage' title='Garbage'>",e+="<span class='iconlbl'>Garbage</span>");"0"!==f.Recycling&&(b+="<img src='"+g.bluebin+"' alt='Recycle' title='Recycle'>",e+="<span class='iconlbl'>Recycle</span>");"0"!==f.YardWaste&&(b+="<img src='"+g.yardWaste+"' alt='Yard Waste' title='Yard Waste'>",e+="<span class='iconlbl'>Yard Waste</span>");
"0"!==f.ChristmasTree&&(b+="<img src='"+g.ctree+"' alt='Christmas Tree' title='Christmas Tree'>",e+="<span class='iconlbl'>Tree</span>");b+="</p>";b+=e}});""===b?(b="<p class='listingerr'>No collection schedule was found ("+k+")</p>",$("#colCal").hide()):(b="<p class='listingerr'>The next curbside collection for "+$("#searchLocation").val()+" is on:</p>"+b,$("#colCalLink").attr("href","http://www1.toronto.ca/city_of_toronto/solid_waste_management_services/shared_content/files/calendars/"+k.replace(/\s/g,
"_").toLowerCase()+".pdf"));$("#calendar").show();$("#calendarData").html(b)}function y(a){l=a;t()}function z(a,c,d){$("#map").show();m=new google.maps.Map(document.getElementById("map-canvas"),{zoom:18,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DEFAULT,position:google.maps.ControlPosition.TOP_RIGHT},zoomControl:!0,draggable:!1});a=new google.maps.LatLng(a,c);new google.maps.Marker({position:a,map:m,icon:"http://maps.google.com/mapfiles/kml/pal2/icon13.png",
title:d});m.setCenter(a)}function u(a){z(a.lat,a.lng,a.addr);a="http://gis.toronto.ca/arcgis/rest/services/primary/cot_geospatial21_mtm/MapServer/3/query?where=&text=&objectIds=&time=&geometry=<LNG>%2C<LAT>&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelWithin&relationParam=&outFields=AREA_ID%2CAREA_ATTR_ID%2CPARENT_AREA_ID%2CAREA_SHORT_CODE%2CAREA_NAME%2CAREA_DESC&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=3857&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&returnTrueCurves=false&resultOffset=&resultRecordCount=&f=pjson".replace("<LNG>",
a.lng).replace("<LAT>",a.lat);$.ajax({type:"GET",url:a,context:this,dataType:"jsonp",success:function(a){k=a.features[0].attributes.AREA_NAME;null===l?Tabletop.init({key:"https://docs.google.com/spreadsheets/d/1KhilmUiWocTvXGpfIARlc-rcL8rRZJUqNyozcMer_iM/pubhtml",callback:y,simpleSheet:!0}):t()},error:function(a,d,b){bootbox.alert("Sorry, we can't determine the pickup schedule at this time.");$("#calendar").hide()}})}function v(){n=new AddressLookup({matchType:1,address:$("#searchLocation").val(),
resultsDisplaySelector:"#COTAddress"});n.getAddressData()}function A(){$("#btnAddrSearch").on("click",function(){v()});$("#COTAddress").on("change",function(){var a=n.getAddressObject();$("#searchLocation").val(a.key_Desc);a={addr:a.key_Desc,lat:a.latitude,lng:a.longitude};q(a);r(a);u(a)});$("#searchLocation").on("keypress",function(a){a=a.which||a.keyCode||0;13!==a&&9!==a||v()});$(".hasclear").keyup(function(){var a=$(this);a.next("span").toggle(!!a.val())});$(".clearer").click(function(){$(this).prev("input").val("").focus();
$(this).hide();r(null);q({addr:null,lat:null,lng:null})})}function w(){A();var a=p(),c={};if("undefined"!==typeof a.addr)c={lat:a.lat,lng:a.lng,addr:a.addr};else{a={};if("undefined"!==typeof Storage&&(c=localStorage.getItem("SWM_CC")))try{a=JSON.parse(c)}catch(d){}c=a}"undefined"!==typeof c.addr&&"undefined"!==typeof c.lat&&"undefined"!==typeof c.lng&&($("#searchLocation").val(c.addr),u(c))}function B(){var a="";0===document.location.hostname.length?(g={bluebin:"images/bluebin.png",greenbin:"images/greenbin.png",
garbage:"images/garbagebin.png",yardWaste:"images/yardwaste.png",ctree:"images/ctree.png",home:"images/home.png"},a+='<link rel="stylesheet" href="css/SWMCalendar.css"><script type="text/javascript" src="js/bootbox.js">\x3c/script>',a+='<script type="text/javascript" src="js/tabletop.js">\x3c/script>',a+='<script type="text/javascript" src="static_files/assets/datepicker/moment-with-locales.js">\x3c/script>',a+='<script type="text/javascript" src="js/addressLookup.min.js">\x3c/script>',$("#appCode").html(a),
$("#appDisplay").load("html/SWMCalendar.html",function(){w()})):(a+='<link rel="stylesheet" href="/static_files/WebApps/SWM%20Collection%20Calendar/css/SWMCalendar.css">',a+='<script type="text/javascript" src="/static_files/assets/bootbox/bootbox.min.js">\x3c/script>',a+='<script type="text/javascript" src="/static_files/assets/tabletop/tabletop.js">\x3c/script>',a+='<script type="text/javascript" src="/static_files/assets/datepicker/moment-with-locales.js">\x3c/script>',a+='<script type="text/javascript" src="/static_files/WebApps/SWM%20Collection%20Calendar/js/addressLookup.min.js">\x3c/script>',
$("#appCode").html(a),$("#appDisplay").load("/static_files/WebApps/SWM%20Collection%20Calendar/html/SWMCalendar.html",function(){w()}))}var l=null,k,m,n,g={bluebin:"/static_files/WebApps/Waste Wizard/files/bluebin.png",greenbin:"/static_files/WebApps/Waste Wizard/files/greenbin.png",garbage:"/static_files/WebApps/Waste Wizard/files/garbagebin.png",yardWaste:"/static_files/WebApps/Waste Wizard/files/yardwaste.png",ctree:"/static_files/WebApps/Waste Wizard/files/ctree.png",home:"/static_files/WebApps/Waste Wizard/files/home.png"};
$(document).ready(function(){B()})})(this);
