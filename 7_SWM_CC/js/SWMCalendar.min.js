(function(k,C){function p(){for(var a={},b=k.location.search.substr(1).split("&"),d=0;d<b.length;d++)if(""!==b[d]){var c=b[d].split("=");2==c.length&&(a[c[0]]=decodeURIComponent(c[1].replace(/\+/g," ")))}return a}function x(a){var b="";Object.keys(a).forEach(function(d,c,e){b+=""===b?"?":"&";b+=d+"="+a[d]});return b}function q(a){var b=p();$.each(Object.keys(a),function(c,d){null!==a[d]?b[d]=String(a[d]).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,
"&gt;"):delete b[d]});var d=x(b),d=k.location.protocol+"//"+k.location.host+k.location.pathname+d;history.pushState&&history.pushState({},"ignored title",d)}function r(a){"undefined"!==typeof Storage&&(null!==a?localStorage.setItem("SWM_CC",JSON.stringify(a)):localStorage.removeItem("SWM_CC"))}function t(){var a=e.replace(/\s/g,""),b=moment().startOf("day"),d=0,c="";$.each(l,function(e,g){if(g.Calendar===a&&moment(g.WeekStarting)>=b&&2>d){var f="";d++;c+="<p class='listinghdr'>"+moment(g.WeekStarting).format("MMMM Do - dddd")+
"</p>";c+="<p>";"0"!==g.GreenBin&&(c+="<img src='"+h.greenbin+"' alt='Organic' title='Organic'>",f+="<span class='iconlbl'>Organic</span>");"0"!==g.Garbage&&(c+="<img src='"+h.garbage+"' alt='Garbage' title='Garbage'>",f+="<span class='iconlbl'>Garbage</span>");"0"!==g.Recycling&&(c+="<img src='"+h.bluebin+"' alt='Recycle' title='Recycle'>",f+="<span class='iconlbl'>Recycle</span>");"0"!==g.YardWaste&&(c+="<img src='"+h.yardWaste+"' alt='Yard Waste' title='Yard Waste'>",f+="<span class='iconlbl'>Yard Waste</span>");
"0"!==g.ChristmasTree&&(c+="<img src='"+h.ctree+"' alt='Christmas Tree' title='Christmas Tree'>",f+="<span class='iconlbl'>Tree</span>");c+="</p>";c+=f}});""===c?(c="<p class='listingerr'>No collection schedule was found ("+e+")</p>",$("#colCal").hide()):($("#colCal").show(),c="<p class='listinghdr'>The next curbside collection for "+$("#searchLocation").val()+" is on:</p>"+c,$("#calPDFLink").attr("href","http://www1.toronto.ca/City%20Of%20Toronto/Solid%20Waste%20Management%20Services/1%20G&R%202.0/2%20Houses/Collection%20Calendar/Calendars/"+
e.replace(/\s/g,"_").toLowerCase()+".pdf"),$("#pdficon").attr("alt",e.replace(/\s/g,"_").toLowerCase()+".pdf"),$("#calPDFId").text(e.replace(/\s/g,"_")+".pdf"),$("#calICSLink").attr("href","http://localhost:82/7_SWM_CC/Waste Collection (Friday 1).ics"),$("#icsicon").attr("alt",e.replace(/\s/g,"_")+".ics"),$("#calICSId").text(e.replace(/\s/g,"_")+".ics"));$("#calendar").show();$("#calendarData").html(c)}function y(a){l=a.MasterCalendar.elements;t()}function z(a,b,d){$("#map").show();m=new google.maps.Map(document.getElementById("map-canvas"),
{zoom:18,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DEFAULT,position:google.maps.ControlPosition.TOP_RIGHT},zoomControl:!0,draggable:!1});a=new google.maps.LatLng(a,b);new google.maps.Marker({position:a,map:m,icon:"http://maps.google.com/mapfiles/kml/pal2/icon13.png",title:d});m.setCenter(a)}function u(a){z(a.lat,a.lng,a.addr);gisServerCheck.getServer("COT_GEOSPATIAL21_MTM").then(function(b){console.log(b);b="<HOST>/3/query?where=&text=&objectIds=&time=&geometry=<LNG>%2C<LAT>&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelWithin&relationParam=&outFields=AREA_ID%2CAREA_ATTR_ID%2CPARENT_AREA_ID%2CAREA_SHORT_CODE%2CAREA_NAME%2CAREA_DESC&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=3857&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&returnTrueCurves=false&resultOffset=&resultRecordCount=&f=pjson".replace("<HOST>",
b).replace("<LNG>",a.lng).replace("<LAT>",a.lat);$.ajax({type:"GET",url:b,context:this,dataType:"jsonp",success:function(a){e=a.features[0].attributes.AREA_NAME;$("#calendarId").text(e);null===l?Tabletop.init({key:"https://docs.google.com/spreadsheets/d/1Om0nwrYzeombeuMf-1pMksyG7oaTdXVpN3vR7-qrjdo/pubhtml",callback:y,simpleSheet:!1}):t()},error:function(a,b,e){bootbox.alert("Sorry, we can't determine the pickup schedule at this time.");$("#calendar").hide()}})})}function v(){n=new AddressLookup({matchType:1,
address:$("#searchLocation").val(),resultsDisplaySelector:"#COTAddress"});n.getAddressData()}function A(){$("#btnAddrSearch").on("click",function(){v()});$("#COTAddress").on("change",function(){var a=n.getAddressObject();$("#searchLocation").val(a.key_Desc);a={addr:a.key_Desc,lat:a.latitude,lng:a.longitude};q(a);r(a);u(a)});$("#searchLocation").on("keypress",function(a){a=a.which||a.keyCode||0;13!==a&&9!==a||v()});$(".hasclear").keyup(function(){var a=$(this);a.next("span").toggle(!!a.val())});$(".clearer").click(function(){$(this).prev("input").val("").focus();
$(this).hide();r(null);q({addr:null,lat:null,lng:null})})}function w(){A();var a=p(),b={};if("undefined"!==typeof a.addr)b={lat:a.lat,lng:a.lng,addr:a.addr};else{a={};if("undefined"!==typeof Storage&&(b=localStorage.getItem("SWM_CC")))try{a=JSON.parse(b)}catch(d){}b=a}"undefined"!==typeof b.addr&&"undefined"!==typeof b.lat&&"undefined"!==typeof b.lng&&($("#searchLocation").val(b.addr),u(b))}function B(){var a="";0===document.location.hostname.length?(h={bluebin:"images/bluebin.png",greenbin:"images/greenbin.png",
garbage:"images/garbagebin.png",yardWaste:"images/yardwaste.png",ctree:"images/ctree.png",home:"images/home.png"},a+='<link rel="stylesheet" href="css/SWMCalendar.css"><script type="text/javascript" src="js/bootbox.js">\x3c/script>',a+='<script type="text/javascript" src="js/tabletop.js">\x3c/script>',a+='<script type="text/javascript" src="static_files/assets/datepicker/moment-with-locales.js">\x3c/script>',a+='<script type="text/javascript" src="js/addressLookup.min.js">\x3c/script>',a+='<script type="text/javascript" src="js/gisServerCheck.min.js">\x3c/script>',
$("#appSWMCalCode").html(a),$("#appSWMCalDisplay").load("html/SWMCalendar.html",function(){w()})):(a+='<link rel="stylesheet" href="/static_files/WebApps/SWM%20Collection%20Calendar/css/SWMCalendar.css">',a+='<script type="text/javascript" src="/static_files/assets/bootbox/bootbox.min.js">\x3c/script>',a+='<script type="text/javascript" src="/static_files/assets/tabletop/tabletop.js">\x3c/script>',a+='<script type="text/javascript" src="/static_files/assets/datepicker/moment-with-locales.js">\x3c/script>',
a+='<script type="text/javascript" src="/static_files/WebApps/SWM%20Collection%20Calendar/js/addressLookup.min.js">\x3c/script>',a+='<script type="text/javascript" src="/static_files/WebApps/SWM%20Collection%20Calendar/js/gisServerCheck.min.js">\x3c/script>',$("#appSWMCalCode").html(a),$("#appSWMCalDisplay").load("/static_files/WebApps/SWM%20Collection%20Calendar/html/SWMCalendar.html",function(){w()}))}var l=null,e,m,n,h={bluebin:"/static_files/WebApps/Waste%20Wizard/files/bluebin.png",greenbin:"/static_files/WebApps/Waste%20Wizard/files/greenbin.png",
garbage:"/static_files/WebApps/Waste%20Wizard/files/garbagebin.png",yardWaste:"/static_files/WebApps/Waste%20Wizard/files/yardwaste.png",ctree:"/static_files/WebApps/Waste%20Wizard/files/ctree.png",home:"/static_files/WebApps/Waste%20Wizard/files/home.png"};$(document).ready(function(){B()})})(this);
