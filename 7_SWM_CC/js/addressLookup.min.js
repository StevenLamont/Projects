(function(g,h){var b=function(c){"undefined"===typeof bootbox&&alert("bootbox must be loaded before using this library");this.options=c||{};this.apiADDRURLPrefix="http://map.toronto.ca/geoservices/rest/search/rankedsearch?searchString=";this.searchArea=this.options.searchArea||1;this.matchType=this.options.matchType||1;this.retRowLimit=this.options.retRowLimit||10;this.projectionType=this.options.projectionType||1;this.address=this.options.address||"";this.codeSelector=this.options.codeSelector||
"#appCode";this.displaySelector=this.options.displaySelector||"#appDisplay";this.resultsDisplaySelector=this.options.resultsDisplaySelector||"#resultsDisplay";this.inputSelector=this.options.inputSelector||"#searchLocation";this.addressObject={}};b.prototype.lookupParms=function(){return"&searchArea="+this.searchArea+"&matchType="+this.matchType+"&projectionType="+this.projectionType+"&retRowLimit="+this.retRowLimit};b.prototype.setAddress=function(c){this.address=c};b.prototype.getAddressObject=
function(){return this.addressObject};b.prototype.promptUser=function(c){for(var a={message:"<b>No extact address was found. Please select one of the following</b>",show:!0,backdrop:!0,closeButton:!0,animate:!0,buttons:{}},e=0;e<c.length;e++){var b=c[e];a.buttons[b.key_Desc]={className:"btn-default addrSelect","data-item":b}}var d=this,f=bootbox.dialog(a);f.on("shown.bs.modal",function(){f.attr("id","addressLookupDiag");f.css("z-index","99001");var a=f.find("button.addrSelect");a[0].focus();a.css("width",
"100%");a.css("margin","0 0 5px 0");a.on("click",$.proxy(function(a){a=$(a.currentTarget).attr("data-bb-handler");for(var b=0;b<c.length;b++)c[b].key_Desc==a&&(this.addressObject=c[b],$(this.resultsDisplaySelector).html(a),$(this.resultsDisplaySelector).change())},d));a.on("keydown",$.proxy(function(a){40===a.which&&$(a.target).next().focus();38===a.which&&$(a.target).prev().focus()},d))})};b.prototype.determineAddresses=function(c){var a=!1,b=[];$.each(c.result.bestResult,function(c,d){"Exact"===
d.matchType&&"Address"===d.featureClass&&(b.push(d),a=!0)});a||(b=$.merge(c.result.bestResult,$.merge(c.result.likelyResults,c.result.restOfResults)));return b};b.prototype.getAddressData=function(){this.results=[];$(this.resultsDisplaySelector).html("");var b=this.apiADDRURLPrefix+encodeURIComponent(this.address)+this.lookupParms(),b=$.ajax({type:"GET",url:b,context:this,dataType:"jsonp",error:function(a,b,c){this.processError.call(this,a,b,c)}});$.when(b).done(function(a){a=this.determineAddresses(a);
0===a.length?(a=bootbox.alert("No addresss information found. Please try again with Street Number and Street Name, or a Place Name. "),a.attr("id","addressLookupDiag"),a.css("z-index","99001")):1==a.length?(this.addressObject=a[0],$(this.resultsDisplaySelector).html(a[0].key_Desc),$(this.resultsDisplaySelector).change()):this.promptUser(a)})};b.prototype.processError=function(b,a,e){$(this.resultsDisplaySelector).html(a+" "+e)};g.AddressLookup=b})(this);
